var glue=function(n,e){"use strict";var t,o,c,i,r,s,a,u,l=function(){var t,o={};return o.open=function(){try{var c;c=n.match("^https://")?"wss"+n.substr(5):"ws"+n.substr(4),c+=e.baseURL+"ws",t=new WebSocket(c),t.onmessage=function(n){o.onMessage(n.data.toString())},t.onerror=function(n){var e="the websocket closed the connection with ";e+=n.code?"the error code: "+n.code:"an error.",o.onError(e)},t.onclose=function(){o.onClose()},t.onopen=function(){o.onOpen()}}catch(i){o.onError()}},o.send=function(n){t.send(n)},o.reset=function(){t&&t.close(),t=void 0},o},f=function(){var t,o,c,i=n+e.baseURL+"ajax",r=8e3,s=45e3,a={Timeout:"t",Closed:"c"},u={Delimiter:"&",Init:"i",Push:"u",Poll:"o"},l={},f=!1,d=!1,g=function(){c=function(){},f&&f.abort(),d&&d.abort()},v=function(){g(),l.onClose()},m=function(n){g(),n=n?"the ajax socket closed the connection with the error: "+n:"the ajax socket closed the connection with an error.",l.onError(n)},h=function(n,e){d=$.ajax({url:i,success:function(n){d=!1,e&&e(n)},error:function(n,e){d=!1,m(e)},type:"POST",data:n,dataType:"text",timeout:r})};return c=function(){f=$.ajax({url:i,success:function(n){if(f=!1,n==a.Timeout)return void c();if(n==a.Closed)return void v();var e=n.indexOf(u.Delimiter);return 0>e?void m("ajax socket: failed to split poll token from data!"):(o=n.substring(0,e),n=n.substr(e+1),c(),void l.onMessage(n))},error:function(n,e){f=!1,m(e)},type:"POST",data:u.Poll+t+u.Delimiter+o,dataType:"text",timeout:s})},l.open=function(){h(u.Init,function(n){var e=n.indexOf(u.Delimiter);return 0>e?void m("ajax socket: failed to split uid and poll token from data!"):(t=n.substring(0,e),o=n.substr(e+1),c(),void l.onOpen())})},l.send=function(n){h(u.Push+t+u.Delimiter+n)},l.reset=function(){g()},l},d="1.3.1",g="&",v="m",m={WebSocket:"WebSocket",AjaxSocket:"AjaxSocket"},h={Len:2,Init:"in",Ping:"pi",Pong:"po",Close:"cl",Invalid:"iv",DontAutoReconnect:"dr",ChannelData:"cd"},p={Disconnected:"disconnected",Connecting:"connecting",Reconnecting:"reconnecting",Connected:"connected"},b={baseURL:"/glue/",forceSocketType:!1,connectTimeout:1e4,pingInterval:35e3,pingReconnectTimeout:5e3,reconnect:!0,reconnectDelay:1e3,reconnectDelayMax:5e3,reconnectAttempts:10,resetSendBufferTimeout:1e4},k=!1,y=!1,M=p.Disconnected,T=0,x=!1,D=!1,S=!1,C=!1,w=[],L=!1,O=!1,I=!1,R=[],j=function(){var n={};return n.unmarshalValues=function(n){if(!n)return!1;var e=n.indexOf(g),t=parseInt(n.substring(0,e),10);if(n=n.substring(e+1),0>t||t>n.length)return!1;var o=n.substr(0,t),c=n.substr(t);return{first:o,second:c}},n.marshalValues=function(n,e){return String(n.length)+g+n+e},n}(),P=function(){var n={},e={},t=function(n){var e={onMessageFunc:function(){}};return e.instance={onMessage:function(n){e.onMessageFunc=n},send:function(e,t){return e?s(h.ChannelData,j.marshalValues(n,e),t):-1}},e};return n.get=function(n){if(!n)return!1;var o=e[n];return o?o.instance:(o=t(n),e[n]=o,o.instance)},n.emitOnMessage=function(n,t){if(n&&t){var o=e[n];if(!o)return void console.log("glue: channel '"+n+"': emit onMessage event: channel does not exists");try{o.onMessageFunc(t)}catch(c){return void console.log("glue: channel '"+n+"': onMessage event call failed: "+c.message)}}},n}();r=function(n){return k?I?void k.send(n):void R.push(n):void 0};var A=function(){if(0!==R.length){for(var n=0;n<R.length;n++)r(R[n]);R=[]}},U=function(){O=!1,L!==!1&&(clearTimeout(L),L=!1)},W=function(){L!==!1||O||(L=setTimeout(function(){if(L=!1,O=!0,0!==w.length){for(var n,e=0;e<w.length;e++)if(n=w[e],n.discardCallback&&$.isFunction(n.discardCallback))try{n.discardCallback(n.data)}catch(t){console.log("glue: failed to call discard callback: "+t.message)}u("discard_send_buffer"),w=[]}},e.resetSendBufferTimeout))},B=function(){if(U(),0!==w.length){for(var n,e=0;e<w.length;e++)n=w[e],r(n.cmd+n.data);w=[]}};s=function(n,e,t){return e||(e=""),k&&M===p.Connected?(r(n+e),1):O?(t&&$.isFunction(t)&&t(e),-1):(W(),w.push({cmd:n,data:e,discardCallback:t}),0)};var _=function(){D!==!1&&(clearTimeout(D),D=!1)},V=function(){_(),D=setTimeout(function(){D=!1,u("connect_timeout"),a()},e.connectTimeout)},E=function(){S!==!1&&(clearTimeout(S),S=!1),C!==!1&&(clearTimeout(C),C=!1)},F=function(){E(),S=setTimeout(function(){S=!1,r(h.Ping),C=setTimeout(function(){C=!1,u("timeout"),a()},e.pingReconnectTimeout)},e.pingInterval)},q=function(){return y?void(k=o()):T>1?(o=f,k=o(),void(c=m.AjaxSocket)):(!e.forceSocketType&&window.WebSocket||e.forceSocketType===m.WebSocket?(o=l,c=m.WebSocket):(o=f,c=m.AjaxSocket),void(k=o()))},J=function(n){n=JSON.parse(n),I=!0,A(),M=p.Connected,u("connected"),setTimeout(B,0)},N=function(){q(),k.onOpen=function(){_(),T=0,y=!0,F();var n={version:d};n=JSON.stringify(n),k.send(h.Init+n)},k.onClose=function(){a()},k.onError=function(n){u("error",[n]),a()},k.onMessage=function(n){if(F(),n.length<h.Len)return void console.log("glue: received invalid data from server: data is too short.");var e=n.substr(0,h.Len);if(n=n.substr(h.Len),e===h.Ping)r(h.Pong);else if(e===h.Pong);else if(e===h.Invalid)console.log("glue: server replied with an invalid request notification!");else if(e===h.DontAutoReconnect)x=!0,console.log("glue: server replied with an don't automatically reconnect request. This might be due to an incompatible protocol version.");else if(e===h.Init)J(n);else if(e===h.ChannelData){var t=j.unmarshalValues(n);if(!t)return void console.log("glue: server requested an invalid channel data request: "+n);P.emitOnMessage(t.first,t.second)}else console.log("glue: received invalid data from server with command '"+e+"' and data '"+n+"'!")},setTimeout(function(){T>0?(M=p.Reconnecting,u("reconnecting")):(M=p.Connecting,u("connecting")),V(),k.open()},0)},z=function(){_(),E(),I=!1,R=[],k&&(k.onOpen=k.onClose=k.onMessage=k.onError=function(){},k.reset(),k=!1)};if(a=function(){if(z(),e.reconnectAttempts>0&&T>e.reconnectAttempts||e.reconnect===!1||x)return M=p.Disconnected,void u("disconnected");T+=1;var n=e.reconnectDelay*T;n>e.reconnectDelayMax&&(n=e.reconnectDelayMax),setTimeout(function(){N()},n)},i=function(){k&&(r(h.Close),z(),M=p.Disconnected,u("disconnected"))},t=P.get(v),n||(n=window.location.protocol+"//"+window.location.host),!n.match("^http://")&&!n.match("^https://"))return void console.log("glue: invalid host: missing 'http://' or 'https://'!");e=$.extend(b,e),e.reconnectDelayMax<e.reconnectDelay&&(e.reconnectDelayMax=e.reconnectDelay),0!==e.baseURL.indexOf("/")&&(e.baseURL="/"+e.baseURL),"/"!==e.baseURL.slice(-1)&&(e.baseURL=e.baseURL+"/"),N();var H={version:function(){return d},type:function(){return c},state:function(){return M},send:function(n,e){t.send(n,e)},onMessage:function(n){t.onMessage(n)},on:function(){var n=$(H);n.on.apply(n,arguments)},reconnect:function(){M===p.Disconnected&&(T=0,x=!1,a())},close:function(){i()},channel:function(n){return P.get(n)}};return u=function(){var n=$(H);n.triggerHandler.apply(n,arguments)},H},BitMonster=function(n){"use strict";var e={},t=function(){var n="&",e={};return e.randomString=function(n){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=0;n>o;o++)e+=t.charAt(Math.floor(Math.random()*t.length));return e},e.unmarshalValues=function(e){if(!e)return!1;var t=e.indexOf(n),o=parseInt(e.substring(0,t),10);if(e=e.substring(t+1),0>o||o>e.length)return!1;var c=e.substr(0,o),i=e.substr(o);return{first:c,second:i}},e.marshalValues=function(e,t){return String(e.length)+n+e+t},e}(),o={en:{ConnLostWidget:{Title:"Connection Lost"}}},c=o.en,i=(navigator.language||navigator.browserLanguage).split("-")[0];i&&o[i]&&(c=o[i]);var r=(function(){var n,e={},t='<div id="bm-conn-lost-widget"><i class="fa fa-bolt fa-2x"></i><span><p></p><small></small></span></div>',o=function(e){n.find("p").text(e)},i=function(e){n.find("small").text(e)},r=function(){n=$("#bm-conn-lost-widget"),n.length||(n=$(t),$("body").prepend(n))};return e.show=function(){r(),o(c.ConnLostWidget.Title),i(c.ConnLostWidget.Title),n.addClass("show")},e}(),function(){var e=glue(n,{baseURL:"/bitmonster/"});return e?(e.on("connected",function(){console.log("connected")}),e.on("connecting",function(){console.log("connecting")}),e.on("disconnected",function(){console.log("disconnected")}),e.on("reconnecting",function(){console.log("reconnecting")}),e.on("error",function(n,e){console.log("error: "+e)}),e.on("connect_timeout",function(){console.log("connect_timeout")}),e.on("timeout",function(){console.log("timeout")}),e.on("discard_send_buffer",function(n,e){console.log("discard_send_buffer: ");for(var t=0;t<e.length;t++)console.log("  i: "+e[t])}),e.onMessage(function(n){console.log("onMessage: "+n)}),e):void console.log("BitMonster: failed to initialize socket!")}());return e.module=function(){var n=14,e=r.channel("call"),o={};return e.onMessage(function(n){var e=function(){console.log("BitMonster: received invalid call request from server.")};if(n=JSON.parse(n),!n.callbackID||0===String(n.callbackID).length)return void e();var t=o[n.callbackID];if(!t)return void e();delete o[n.callbackID];try{if("cleanup"===n.type)return;"success"===n.type&&t.success?n.data?t.success(n.data):t.success():"error"===n.type&&t.error?n.message?t.error(n.message):t.error():e()}catch(c){console.log("BitMonster: catched exception while calling callback:"),console.log(c)}}),function(c){return c?{call:function(i){var r=!1,s=!1,a=!1,u=function(){console.log("BitMonster: invalid function call: module='"+c+"' method='"+i+"'")};if(!i)return u(),!1;for(var l=1;l<arguments.length;l++){var f=arguments[l];if(null!==f&&"object"==typeof f){if(r!==!1)return u(),!1;r=f}else{if(!$.isFunction(f))return u(),!1;if(s===!1)s=f;else{if(a!==!1)return u(),!1;a=f}}}r=r?JSON.stringify(r):"";var d={module:c,method:i};if(s!==!1||a!==!1){for(var g;;)if(g=t.randomString(n),!o[g])break;o[g]={success:s,error:a},d.callbackID=g,d.callbackSuccess=s!==!1,d.callbackError=a!==!1}return d=JSON.stringify(d),e.send(t.marshalValues(d,r)),!0}}:(console.log("BitMonster: invalid module call: module='"+c+"'"),!1)}}(),e};