var glue=function(e,n){"use strict";var t,o,i,r,c,a,s,u,l=function(){var t,o={};return o.open=function(){try{var i;i=e.match("^https://")?"wss"+e.substr(5):"ws"+e.substr(4),i+=n.baseURL+"ws",t=new WebSocket(i),t.onmessage=function(e){o.onMessage(e.data.toString())},t.onerror=function(e){var n="the websocket closed the connection with ";n+=e.code?"the error code: "+e.code:"an error.",o.onError(n)},t.onclose=function(){o.onClose()},t.onopen=function(){o.onOpen()}}catch(r){o.onError()}},o.send=function(e){t.send(e)},o.reset=function(){t&&t.close(),t=void 0},o},d=function(){var t,o,i,r=e+n.baseURL+"ajax",c=8e3,a=45e3,s={Timeout:"t",Closed:"c"},u={Delimiter:"&",Init:"i",Push:"u",Poll:"o"},l={},d=!1,f=!1,g=function(){i=function(){},d&&d.abort(),f&&f.abort()},v=function(){g(),l.onClose()},h=function(e){g(),e=e?"the ajax socket closed the connection with the error: "+e:"the ajax socket closed the connection with an error.",l.onError(e)},m=function(e,n){f=$.ajax({url:r,success:function(e){f=!1,n&&n(e)},error:function(e,n){f=!1,h(n)},type:"POST",data:e,dataType:"text",timeout:c})};return i=function(){d=$.ajax({url:r,success:function(e){if(d=!1,e==s.Timeout)return void i();if(e==s.Closed)return void v();var n=e.indexOf(u.Delimiter);return 0>n?void h("ajax socket: failed to split poll token from data!"):(o=e.substring(0,n),e=e.substr(n+1),i(),void l.onMessage(e))},error:function(e,n){d=!1,h(n)},type:"POST",data:u.Poll+t+u.Delimiter+o,dataType:"text",timeout:a})},l.open=function(){m(u.Init,function(e){var n=e.indexOf(u.Delimiter);return 0>n?void h("ajax socket: failed to split uid and poll token from data!"):(t=e.substring(0,n),o=e.substr(n+1),i(),void l.onOpen())})},l.send=function(e){m(u.Push+t+u.Delimiter+e)},l.reset=function(){g()},l},f="1.7.0",g="m",v={WebSocket:"WebSocket",AjaxSocket:"AjaxSocket"},h={Len:2,Init:"in",Ping:"pi",Pong:"po",Close:"cl",Invalid:"iv",DontAutoReconnect:"dr",ChannelData:"cd"},m={Disconnected:"disconnected",Connecting:"connecting",Reconnecting:"reconnecting",Connected:"connected"},p={baseURL:"/glue/",forceSocketType:!1,connectTimeout:1e4,pingInterval:35e3,pingReconnectTimeout:5e3,reconnect:!0,reconnectDelay:1e3,reconnectDelayMax:5e3,reconnectAttempts:10,resetSendBufferTimeout:1e4},b=!1,k=!1,y=m.Disconnected,T=0,C=!1,x=!1,S=!1,D=!1,w=[],I=!1,M=!1,O=!1,A=[],j="",R=function(){var e="&",n={};return n.unmarshalValues=function(n){if(!n)return!1;var t=n.indexOf(e),o=parseInt(n.substring(0,t),10);if(n=n.substring(t+1),0>o||o>n.length)return!1;var i=n.substr(0,o),r=n.substr(o);return{first:i,second:r}},n.marshalValues=function(n,t){return String(n.length)+e+n+t},n}(),L=function(){var e={},n={},t=function(e){var n={onMessageFunc:function(){}};return n.instance={onMessage:function(e){n.onMessageFunc=e},send:function(n,t){return n?a(h.ChannelData,R.marshalValues(e,n),t):-1}},n};return e.get=function(e){if(!e)return!1;var o=n[e];return o?o.instance:(o=t(e),n[e]=o,o.instance)},e.emitOnMessage=function(e,t){if(e&&t){var o=n[e];if(!o)return void console.log("glue: channel '"+e+"': emit onMessage event: channel does not exists");try{o.onMessageFunc(t)}catch(i){return void console.log("glue: channel '"+e+"': onMessage event call failed: "+i.message)}}},e}();c=function(e){return b?O?void b.send(e):void A.push(e):void 0};var U=function(){if(0!==A.length){for(var e=0;e<A.length;e++)c(A[e]);A=[]}},P=function(){M=!1,I!==!1&&(clearTimeout(I),I=!1)},B=function(){I!==!1||M||(I=setTimeout(function(){if(I=!1,M=!0,0!==w.length){for(var e,n=0;n<w.length;n++)if(e=w[n],e.discardCallback&&$.isFunction(e.discardCallback))try{e.discardCallback(e.data)}catch(t){console.log("glue: failed to call discard callback: "+t.message)}u("discard_send_buffer"),w=[]}},n.resetSendBufferTimeout))},F=function(){if(P(),0!==w.length){for(var e,n=0;n<w.length;n++)e=w[n],c(e.cmd+e.data);w=[]}};a=function(e,n,t){return n||(n=""),b&&y===m.Connected?(c(e+n),1):M?(t&&$.isFunction(t)&&t(n),-1):(B(),w.push({cmd:e,data:n,discardCallback:t}),0)};var N=function(){x!==!1&&(clearTimeout(x),x=!1)},_=function(){N(),x=setTimeout(function(){x=!1,u("connect_timeout"),s()},n.connectTimeout)},J=function(){S!==!1&&(clearTimeout(S),S=!1),D!==!1&&(clearTimeout(D),D=!1)},E=function(){J(),S=setTimeout(function(){S=!1,c(h.Ping),D=setTimeout(function(){D=!1,u("timeout"),s()},n.pingReconnectTimeout)},n.pingInterval)},V=function(){return k?void(b=o()):T>1?(o=d,b=o(),void(i=v.AjaxSocket)):(!n.forceSocketType&&window.WebSocket||n.forceSocketType===v.WebSocket?(o=l,i=v.WebSocket):(o=d,i=v.AjaxSocket),void(b=o()))},q=function(e){return e=JSON.parse(e),e.socketID?(j=e.socketID,O=!0,U(),y=m.Connected,u("connected"),void setTimeout(F,0)):(r(),void console.log("glue: socket initialization failed: invalid initialization data received"))},W=function(){V(),b.onOpen=function(){N(),T=0,k=!0,E();var e={version:f};e=JSON.stringify(e),b.send(h.Init+e)},b.onClose=function(){s()},b.onError=function(e){u("error",[e]),s()},b.onMessage=function(e){if(E(),e.length<h.Len)return void console.log("glue: received invalid data from server: data is too short.");var n=e.substr(0,h.Len);if(e=e.substr(h.Len),n===h.Ping)c(h.Pong);else if(n===h.Pong);else if(n===h.Invalid)console.log("glue: server replied with an invalid request notification!");else if(n===h.DontAutoReconnect)C=!0,console.log("glue: server replied with an don't automatically reconnect request. This might be due to an incompatible protocol version.");else if(n===h.Init)q(e);else if(n===h.ChannelData){var t=R.unmarshalValues(e);if(!t)return void console.log("glue: server requested an invalid channel data request: "+e);L.emitOnMessage(t.first,t.second)}else console.log("glue: received invalid data from server with command '"+n+"' and data '"+e+"'!")},setTimeout(function(){T>0?(y=m.Reconnecting,u("reconnecting")):(y=m.Connecting,u("connecting")),_(),b.open()},0)},z=function(){N(),J(),O=!1,j="",A=[],b&&(b.onOpen=b.onClose=b.onMessage=b.onError=function(){},b.reset(),b=!1)};if(s=function(){if(z(),n.reconnectAttempts>0&&T>n.reconnectAttempts||n.reconnect===!1||C)return y=m.Disconnected,void u("disconnected");T+=1;var e=n.reconnectDelay*T;e>n.reconnectDelayMax&&(e=n.reconnectDelayMax),setTimeout(function(){W()},e)},r=function(){b&&(c(h.Close),z(),y=m.Disconnected,u("disconnected"))},t=L.get(g),e||(e=window.location.protocol+"//"+window.location.host),!e.match("^http://")&&!e.match("^https://"))return void console.log("glue: invalid host: missing 'http://' or 'https://'!");n=$.extend(p,n),n.reconnectDelayMax<n.reconnectDelay&&(n.reconnectDelayMax=n.reconnectDelay),0!==n.baseURL.indexOf("/")&&(n.baseURL="/"+n.baseURL),"/"!==n.baseURL.slice(-1)&&(n.baseURL=n.baseURL+"/"),W();var H={version:function(){return f},type:function(){return i},state:function(){return y},socketID:function(){return j},send:function(e,n){t.send(e,n)},onMessage:function(e){t.onMessage(e)},on:function(){var e=$(H);e.on.apply(e,arguments)},reconnect:function(){y===m.Disconnected&&(T=0,C=!1,s())},close:function(){r()},channel:function(e){return L.get(e)}};return u=function(){var e=$(H);e.triggerHandler.apply(e,arguments)},H};Object.keys||(Object.keys=function(){"use strict";var e=Object.prototype.hasOwnProperty,n=!{toString:null}.propertyIsEnumerable("toString"),t=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],o=t.length;return function(i){if("object"!=typeof i&&("function"!=typeof i||null===i))throw new TypeError("Object.keys called on non-object");var r,c,a=[];for(r in i)e.call(i,r)&&a.push(r);if(n)for(c=0;o>c;c++)e.call(i,t[c])&&a.push(t[c]);return a}}());var BitMonster=function(e){"use strict";var n={};e||(e="");var t=function(){var e="&",n={},t=function(e,n){var t,o,i,r,c,a,s,u;for(t=3&e.length,o=e.length-t,i=n,c=3432918353,a=461845907,u=0;o>u;)s=255&e.charCodeAt(u)|(255&e.charCodeAt(++u))<<8|(255&e.charCodeAt(++u))<<16|(255&e.charCodeAt(++u))<<24,++u,s=(65535&s)*c+(((s>>>16)*c&65535)<<16)&4294967295,s=s<<15|s>>>17,s=(65535&s)*a+(((s>>>16)*a&65535)<<16)&4294967295,i^=s,i=i<<13|i>>>19,r=5*(65535&i)+((5*(i>>>16)&65535)<<16)&4294967295,i=(65535&r)+27492+(((r>>>16)+58964&65535)<<16);switch(s=0,t){case 3:s^=(255&e.charCodeAt(u+2))<<16;case 2:s^=(255&e.charCodeAt(u+1))<<8;case 1:s^=255&e.charCodeAt(u),s=(65535&s)*c+(((s>>>16)*c&65535)<<16)&4294967295,s=s<<15|s>>>17,s=(65535&s)*a+(((s>>>16)*a&65535)<<16)&4294967295,i^=s}return i^=e.length,i^=i>>>16,i=2246822507*(65535&i)+((2246822507*(i>>>16)&65535)<<16)&4294967295,i^=i>>>13,i=3266489909*(65535&i)+((3266489909*(i>>>16)&65535)<<16)&4294967295,i^=i>>>16,i>>>0};return n.storageAvailable=function(e){try{var n=window[e],t="__storage_test__";return n.setItem(t,t),n.removeItem(t),!0}catch(o){return!1}},n.callCatch=function(e){Array.prototype.shift.call(arguments);try{e.apply(e,arguments)}catch(n){console.log("BitMonster: catched exception while calling callback:"),console.log(n)}},n.randomString=function(e){for(var n="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=0;e>o;o++)n+=t.charAt(Math.floor(Math.random()*t.length));return n},n.unmarshalValues=function(n){if(!n)return!1;var t=n.indexOf(e),o=parseInt(n.substring(0,t),10);if(n=n.substring(t+1),0>o||o>n.length)return!1;var i=n.substr(0,o),r=n.substr(o);return{first:i,second:r}},n.marshalValues=function(n,t){return String(n.length)+e+n+t},n.browserFingerprint=function(){var e=[navigator.userAgent,(new Date).getTimezoneOffset(),!!window.sessionStorage,!!window.localStorage,$.map(navigator.plugins,function(e){return[e.name,e.description,$.map(e,function(e){return[e.type,e.suffixes].join("~")}).join(",")].join("::")}).join(";")].join("###");return String(t(e,2155905152))},n.cookies={getItem:function(e){return e?decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null:null},setItem:function(e,n,t,o,i,r){if(!e||/^(?:expires|max\-age|path|domain|secure)$/i.test(e))return!1;var c="";if(t)switch(t.constructor){case Number:c=t===1/0?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+t;break;case String:c="; expires="+t;break;case Date:c="; expires="+t.toUTCString()}return document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(n)+c+(i?"; domain="+i:"")+(o?"; path="+o:"")+(r?"; secure":""),!0},removeItem:function(e,n,t){return this.hasItem(e)?(document.cookie=encodeURIComponent(e)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(t?"; domain="+t:"")+(n?"; path="+n:""),!0):!1},hasItem:function(e){return e?new RegExp("(?:^|;\\s*)"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie):!1},keys:function(){for(var e=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),n=e.length,t=0;n>t;t++)e[t]=decodeURIComponent(e[t]);return e}},n}(),o={en:{socket:{ConnLostTitle:"Connection Lost",ConnLostText:"Trying to reconnect to Server...",DiscardNotSendDataTitle:"Unsend Data",DiscardNotSendDataText:"Not all data messages could be transmitted to the server!",DisconnectedTitle:"Disconnected from Server",DisconnectedText:"Click here to reconnect."},auth:{FailedTitle:"Authentication failed",FailedText:"Failed to authenticate this session."}}},i=o.en,r=(navigator.language||navigator.browserLanguage).split("-")[0];r&&o[r]&&(i=o[r]),n.notification=function(e){function n(){var n=$("#"+l);return n.length?n:(n=$(f),$("body").prepend(n),e.hideClose?$("#"+l+" > div").remove():$("#"+l+" > div").on("click",function(){e.destroyOnClose?s():a()}),n)}function o(e){n().find("p").text(e)}function i(e){n().find("span").text(e)}function r(){d!==!1&&(clearTimeout(d),d=!1)}function c(e){var t=n();r(),t.removeClass("hide"),t.removeClass("show"),t.addClass("show"),e>0&&(d=setTimeout(function(){d=!1,a()},e))}function a(){var e=n();r(),e.addClass("hide"),d=setTimeout(function(){d=!1,e.removeClass("hide"),e.removeClass("show")},3e3)}function s(){var e=n();r(),e.addClass("hide"),d=setTimeout(function(){d=!1,e.remove()},3e3)}var u={title:"",text:"",destroyOnClose:!0,hideClose:!1},l="bm-notification-"+t.randomString(14),d=!1,f='<div id="'+l+'" class="bm-notification"><div><b></b><b></b><b></b><b></b></div><p></p><span></span></div>';return e=$.extend(u,e),n(),o(e.title),i(e.text),{setTitle:o,setText:i,show:c,hide:a,destroy:s,onClick:function(e){n().addClass("bm-clickable").on("click",e)}}};var c=function(){var e={},t=!1,o=n.notification({title:i.socket.ConnLostTitle,text:i.socket.ConnLostText,destroyOnClose:!1,hideClose:!0});return e.show=function(){t===!1&&(t=setTimeout(function(){t=!1,o.show()},1500))},e.hide=function(){t!==!1&&(clearTimeout(t),t=!1),o.hide()},e}();n.scope=function(){var e={};return function(n){if(!n)return console.log("BitMonster: invalid scope call: scope='"+n+"'"),!1;var t=e[n];t||(t={events:[]});for(var o=1;o<arguments.length;o++){var i=arguments[o];$.isFunction(i.off)?t.events.push(i):console.log("BitMonster: invalid scope call: passed invalid argument: skipping argument...")}return e[n]=t,{off:function(){for(var o=0;o<t.events.length;o++)t.events[o].off();delete e[n]}}}}();var a=function(){var t=glue(e,{baseURL:"/bitmonster/"});return t?(t.on("connected",function(){c.hide()}),t.on("connecting",function(){c.show()}),t.on("reconnecting",function(){c.show()}),t.on("disconnected",function(){c.hide();var e=n.notification({title:i.socket.DisconnectedTitle,text:i.socket.DisconnectedText,hideClose:!0});e.onClick(function(){e.destroy(),t.reconnect()}),e.show()}),t.on("error",function(e,n){console.log("BitMonster: socket error: "+n)}),t.on("discard_send_buffer",function(){n.notification({title:i.socket.DiscardNotSendDataTitle,text:i.socket.DiscardNotSendDataText}).show()}),t):void console.log("BitMonster: failed to initialize socket!")}();return n.module=function(){var e=14,n=10,o=12e3,i=a.channel("call"),r=a.channel("event"),c={},s={};i.onMessage(function(e){var n=function(){console.log("BitMonster: received invalid call request from server.")};if(e=JSON.parse(e),!e.callbackID||0===String(e.callbackID).length)return void n();var o=c[e.callbackID];return o?(delete c[e.callbackID],o.timeout&&(clearTimeout(o.timeout),o.timeout=!1),void("cleanup"!==e.type&&("success"===e.type&&o.success?t.callCatch(o.success,e.data):"error"===e.type&&o.error?t.callCatch(o.error,e.message):n()))):void n()}),r.onMessage(function(e){var n=function(){console.log("BitMonster: received invalid event request from server.")};if(e=JSON.parse(e),!e.module||!e.event)return void n();var t=s[e.module];if(t){var o=t.events[e.event];if(o)if("trigger"===e.type){var i;e.data&&(i=JSON.parse(e.data));var r=jQuery.extend({},o.listeners);$.each(r,function(e,n){try{n.callback(i)}catch(t){console.log("BitMonster: catched exception while triggering event:"),console.log(t)}})}else n()}});var u=function(n,r){var a=!1,s=!1,u=!1,l=function(){console.log("BitMonster: invalid method call: module='"+n+"' method='"+r+"'")};if(!r)return l(),!1;for(var d=2;d<arguments.length;d++){var f=arguments[d];if(null!==f&&"object"==typeof f){if(a!==!1)return l(),!1;a=f}else{if(!$.isFunction(f))return l(),!1;if(s===!1)s=f;else{if(u!==!1)return l(),!1;u=f}}}a=a?JSON.stringify(a):"";var g={module:n,method:r};if(s!==!1||u!==!1){for(var v;;)if(v=t.randomString(e),!c[v])break;var h={success:s,error:u};h.timeout=setTimeout(function(){h.timeout=!1,delete c[v],h.error&&h.error("method call timeout: no server response received within the timeout")},o),c[v]=h,g.callbackID=v,g.callbackSuccess=s!==!1,g.callbackError=u!==!1}return g=JSON.stringify(g),i.send(t.marshalValues(g,a)),!0},l=function(e,n,t){var o=s[e];if(o){var i=o.events[n];if(i&&(delete i.listeners[t],!(Object.keys(i.listeners).length>0))){delete o.events[n];var c={type:"off",module:e,event:n};c=JSON.stringify(c),r.send(c)}}},d=function(e,n){var t={type:"on",module:e,event:n};t=JSON.stringify(t),r.send(t)},f=function(e,o,i){var r=s[e];r||(r={events:{}},s[e]=r);var c=r.events[o];c||(c={listeners:{}},r.events[o]=c);for(var a;;)if(a=t.randomString(n),!c.listeners[a])break;return c.listeners[a]={callback:i},1==Object.keys(c.listeners).length&&d(e,o,a),{off:function(){l(e,o,a)}}};return $(a).on("connected_and_auth",function(){$.each(s,function(e,n){$.each(n.events,function(n,t){d(e,n)})})}),function(e){return e?{call:function(){return Array.prototype.unshift.call(arguments,e),u.apply(u,arguments)},on:function(){return Array.prototype.unshift.call(arguments,e),f.apply(f,arguments)}}:(console.log("BitMonster: invalid module call: module='"+e+"'"),!1)}}(),n.auth=function(){function o(){return b||(b=t.browserFingerprint()),b}function r(){var e;return t.storageAvailable("localStorage")?e=localStorage[h]:t.cookies.hasItem(h)&&(e=t.cookies.getItem(h)),e}function c(e){t.storageAvailable("localStorage")?localStorage.setItem(h,e):t.cookies.setItem(h,e,2592e3)}function s(){t.storageAvailable("localStorage")?localStorage.removeItem(h):t.cookies.removeItem(h)}function u(e,n){var i=r();if(!i)return!1;var c=function(e){f(!1),s(),n&&(t.callCatch(n,e),n=void 0)},u={type:"auth",socketID:a.socketID()},l=$.ajax({url:m,success:function(){l=!1},error:function(e,n){l=!1;var t="HTTP authentication failed";n&&(t+=": "+n),c(t)},type:"POST",data:JSON.stringify(u),timeout:7e3}),g={token:i,fingerprint:o()};return p.call("authenticate",g,function(n){return n.id?(f(n.id),void(e&&t.callCatch(e))):(c("invalid user data received"),void d())},function(e){l&&l.abort(),c(e)}),!0}function l(e,n,i,r){var s=function(){var s=function(e){r&&(t.callCatch(r,e),r=void 0)};if(!e||!n)return void s("invalid login credentials");var l=0,d=function(){return l++,2>l?void 0:u(i,r)?void 0:void s("authentication failed")},f={type:"login",socketID:a.socketID()},g=$.ajax({url:m,success:function(){g=!1,d()},error:function(e,n){g=!1;var t="HTTP authentication failed";n&&(t+=": "+n),s(t)},type:"POST",data:JSON.stringify(f),timeout:7e3}),v={username:e,password:n,fingerprint:o()};p.call("login",v,function(e){return e.token?(c(e.token),void d()):void s("login failed: invalid authentication token")},function(e){g&&g.abort(),s(e)})};"connected"!==a.state()?a.on("connected",s):s()}function d(){f(!1),s(),p.call("logout",function(){},function(e){console.log("BitMonster: failed to logout socket session"),e&&console.log(e)})}function f(e){k!==e&&(k=e,k?($(y).trigger("authChanged",[!0]),$(y).trigger("onAuth")):$(y).trigger("authChanged",[!1]))}function g(){return k?k:!1}function v(){return k?!0:!1}var h="BMAuthToken",m=e+"/bitmonster/auth",p=n.module("auth"),b=!1,k=!1,y={login:l,logout:d,getUserID:g,isAuth:v,onAuth:function(e){$(y).on("onAuth",e)},onAuthChanged:function(e){$(y).on("authChanged",e)}};return a.on("connected",function(){var e=u(function(){$(a).trigger("connected_and_auth")},function(e){$(a).trigger("connected_and_auth"),console.log("BitMonster: failed to authenticate"),e&&console.log("error message: "+e),n.notification({title:i.auth.FailedTitle,text:i.auth.FailedText}).show(1e4)});e||$(a).trigger("connected_and_auth")}),p.on("reauthenticate",function(){u(void 0,function(e){console.log("BitMonster: failed to reauthenticate"),e&&console.log("error message: "+e),n.notification({title:i.auth.FailedTitle,text:i.auth.FailedText}).show(1e4)})}),y}(),n};