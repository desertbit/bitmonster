var glue=function(n,e){"use strict";var t,o,r,i,c,a,s,u,l=function(){var t,o={};return o.open=function(){try{var r;r=n.match("^https://")?"wss"+n.substr(5):"ws"+n.substr(4),r+=e.baseURL+"ws",t=new WebSocket(r),t.onmessage=function(n){o.onMessage(n.data.toString())},t.onerror=function(n){var e="the websocket closed the connection with ";e+=n.code?"the error code: "+n.code:"an error.",o.onError(e)},t.onclose=function(){o.onClose()},t.onopen=function(){o.onOpen()}}catch(i){o.onError()}},o.send=function(n){t.send(n)},o.reset=function(){t&&t.close(),t=void 0},o},f=function(){var t,o,r,i=n+e.baseURL+"ajax",c=8e3,a=45e3,s={Timeout:"t",Closed:"c"},u={Delimiter:"&",Init:"i",Push:"u",Poll:"o"},l={},f=!1,d=!1,g=function(){r=function(){},f&&f.abort(),d&&d.abort()},v=function(){g(),l.onClose()},m=function(n){g(),n=n?"the ajax socket closed the connection with the error: "+n:"the ajax socket closed the connection with an error.",l.onError(n)},h=function(n,e){d=$.ajax({url:i,success:function(n){d=!1,e&&e(n)},error:function(n,e){d=!1,m(e)},type:"POST",data:n,dataType:"text",timeout:c})};return r=function(){f=$.ajax({url:i,success:function(n){if(f=!1,n==s.Timeout)return void r();if(n==s.Closed)return void v();var e=n.indexOf(u.Delimiter);return 0>e?void m("ajax socket: failed to split poll token from data!"):(o=n.substring(0,e),n=n.substr(e+1),r(),void l.onMessage(n))},error:function(n,e){f=!1,m(e)},type:"POST",data:u.Poll+t+u.Delimiter+o,dataType:"text",timeout:a})},l.open=function(){h(u.Init,function(n){var e=n.indexOf(u.Delimiter);return 0>e?void m("ajax socket: failed to split uid and poll token from data!"):(t=n.substring(0,e),o=n.substr(e+1),r(),void l.onOpen())})},l.send=function(n){h(u.Push+t+u.Delimiter+n)},l.reset=function(){g()},l},d="1.3.1",g="m",v={WebSocket:"WebSocket",AjaxSocket:"AjaxSocket"},m={Len:2,Init:"in",Ping:"pi",Pong:"po",Close:"cl",Invalid:"iv",DontAutoReconnect:"dr",ChannelData:"cd"},h={Disconnected:"disconnected",Connecting:"connecting",Reconnecting:"reconnecting",Connected:"connected"},p={baseURL:"/glue/",forceSocketType:!1,connectTimeout:1e4,pingInterval:35e3,pingReconnectTimeout:5e3,reconnect:!0,reconnectDelay:1e3,reconnectDelayMax:5e3,reconnectAttempts:10,resetSendBufferTimeout:1e4},b=!1,y=!1,k=h.Disconnected,M=0,S=!1,D=!1,x=!1,T=!1,C=[],w=!1,O=!1,I=!1,L=[],R=function(){var n="&",e={};return e.unmarshalValues=function(e){if(!e)return!1;var t=e.indexOf(n),o=parseInt(e.substring(0,t),10);if(e=e.substring(t+1),0>o||o>e.length)return!1;var r=e.substr(0,o),i=e.substr(o);return{first:r,second:i}},e.marshalValues=function(e,t){return String(e.length)+n+e+t},e}(),j=function(){var n={},e={},t=function(n){var e={onMessageFunc:function(){}};return e.instance={onMessage:function(n){e.onMessageFunc=n},send:function(e,t){return e?a(m.ChannelData,R.marshalValues(n,e),t):-1}},e};return n.get=function(n){if(!n)return!1;var o=e[n];return o?o.instance:(o=t(n),e[n]=o,o.instance)},n.emitOnMessage=function(n,t){if(n&&t){var o=e[n];if(!o)return void console.log("glue: channel '"+n+"': emit onMessage event: channel does not exists");try{o.onMessageFunc(t)}catch(r){return void console.log("glue: channel '"+n+"': onMessage event call failed: "+r.message)}}},n}();c=function(n){return b?I?void b.send(n):void L.push(n):void 0};var A=function(){if(0!==L.length){for(var n=0;n<L.length;n++)c(L[n]);L=[]}},B=function(){O=!1,w!==!1&&(clearTimeout(w),w=!1)},P=function(){w!==!1||O||(w=setTimeout(function(){if(w=!1,O=!0,0!==C.length){for(var n,e=0;e<C.length;e++)if(n=C[e],n.discardCallback&&$.isFunction(n.discardCallback))try{n.discardCallback(n.data)}catch(t){console.log("glue: failed to call discard callback: "+t.message)}u("discard_send_buffer"),C=[]}},e.resetSendBufferTimeout))},U=function(){if(B(),0!==C.length){for(var n,e=0;e<C.length;e++)n=C[e],c(n.cmd+n.data);C=[]}};a=function(n,e,t){return e||(e=""),b&&k===h.Connected?(c(n+e),1):O?(t&&$.isFunction(t)&&t(e),-1):(P(),C.push({cmd:n,data:e,discardCallback:t}),0)};var J=function(){D!==!1&&(clearTimeout(D),D=!1)},N=function(){J(),D=setTimeout(function(){D=!1,u("connect_timeout"),s()},e.connectTimeout)},W=function(){x!==!1&&(clearTimeout(x),x=!1),T!==!1&&(clearTimeout(T),T=!1)},_=function(){W(),x=setTimeout(function(){x=!1,c(m.Ping),T=setTimeout(function(){T=!1,u("timeout"),s()},e.pingReconnectTimeout)},e.pingInterval)},F=function(){return y?void(b=o()):M>1?(o=f,b=o(),void(r=v.AjaxSocket)):(!e.forceSocketType&&window.WebSocket||e.forceSocketType===v.WebSocket?(o=l,r=v.WebSocket):(o=f,r=v.AjaxSocket),void(b=o()))},V=function(n){n=JSON.parse(n),I=!0,A(),k=h.Connected,u("connected"),setTimeout(U,0)},q=function(){F(),b.onOpen=function(){J(),M=0,y=!0,_();var n={version:d};n=JSON.stringify(n),b.send(m.Init+n)},b.onClose=function(){s()},b.onError=function(n){u("error",[n]),s()},b.onMessage=function(n){if(_(),n.length<m.Len)return void console.log("glue: received invalid data from server: data is too short.");var e=n.substr(0,m.Len);if(n=n.substr(m.Len),e===m.Ping)c(m.Pong);else if(e===m.Pong);else if(e===m.Invalid)console.log("glue: server replied with an invalid request notification!");else if(e===m.DontAutoReconnect)S=!0,console.log("glue: server replied with an don't automatically reconnect request. This might be due to an incompatible protocol version.");else if(e===m.Init)V(n);else if(e===m.ChannelData){var t=R.unmarshalValues(n);if(!t)return void console.log("glue: server requested an invalid channel data request: "+n);j.emitOnMessage(t.first,t.second)}else console.log("glue: received invalid data from server with command '"+e+"' and data '"+n+"'!")},setTimeout(function(){M>0?(k=h.Reconnecting,u("reconnecting")):(k=h.Connecting,u("connecting")),N(),b.open()},0)},E=function(){J(),W(),I=!1,L=[],b&&(b.onOpen=b.onClose=b.onMessage=b.onError=function(){},b.reset(),b=!1)};if(s=function(){if(E(),e.reconnectAttempts>0&&M>e.reconnectAttempts||e.reconnect===!1||S)return k=h.Disconnected,void u("disconnected");M+=1;var n=e.reconnectDelay*M;n>e.reconnectDelayMax&&(n=e.reconnectDelayMax),setTimeout(function(){q()},n)},i=function(){b&&(c(m.Close),E(),k=h.Disconnected,u("disconnected"))},t=j.get(g),n||(n=window.location.protocol+"//"+window.location.host),!n.match("^http://")&&!n.match("^https://"))return void console.log("glue: invalid host: missing 'http://' or 'https://'!");e=$.extend(p,e),e.reconnectDelayMax<e.reconnectDelay&&(e.reconnectDelayMax=e.reconnectDelay),0!==e.baseURL.indexOf("/")&&(e.baseURL="/"+e.baseURL),"/"!==e.baseURL.slice(-1)&&(e.baseURL=e.baseURL+"/"),q();var z={version:function(){return d},type:function(){return r},state:function(){return k},send:function(n,e){t.send(n,e)},onMessage:function(n){t.onMessage(n)},on:function(){var n=$(z);n.on.apply(n,arguments)},reconnect:function(){k===h.Disconnected&&(M=0,S=!1,s())},close:function(){i()},channel:function(n){return j.get(n)}};return u=function(){var n=$(z);n.triggerHandler.apply(n,arguments)},z},BitMonster=function(n){"use strict";var e={},t=function(){var n="&",e={};return e.randomString=function(n){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=0;n>o;o++)e+=t.charAt(Math.floor(Math.random()*t.length));return e},e.unmarshalValues=function(e){if(!e)return!1;var t=e.indexOf(n),o=parseInt(e.substring(0,t),10);if(e=e.substring(t+1),0>o||o>e.length)return!1;var r=e.substr(0,o),i=e.substr(o);return{first:r,second:i}},e.marshalValues=function(e,t){return String(e.length)+n+e+t},e}(),o={en:{ConnLostWidget:{Title:"Connection Lost"}}},r=o.en,i=(navigator.language||navigator.browserLanguage).split("-")[0];i&&o[i]&&(r=o[i]);!function(){var n,e={},t='<div id="bm-conn-lost-widget"><i class="fa fa-bolt fa-2x"></i><span><p></p><small></small></span></div>',o=function(e){n.find("p").text(e)},i=function(e){n.find("small").text(e)},c=function(){n=$("#bm-conn-lost-widget"),n.length||(n=$(t),$("body").prepend(n))};return e.show=function(){c(),o(r.ConnLostWidget.Title),i(r.ConnLostWidget.Title),n.addClass("show")},e}();e.scope=function(){var n={};return function(e){if(!e)return console.log("BitMonster: invalid scope call: scope='"+e+"'"),!1;var t=n[e];t||(t={events:[]});for(var o=1;o<arguments.length;o++){var r=arguments[o];$.isFunction(r.off)?t.events.push(r):console.log("BitMonster: invalid scope call: passed invalid argument: skipping argument...")}return n[e]=t,{off:function(){for(var o=0;o<t.events.length;o++)t.events[o].off();delete n[e]}}}}();var c=function(){var e=glue(n,{baseURL:"/bitmonster/"});return e?(e.on("connected",function(){console.log("connected")}),e.on("connecting",function(){console.log("connecting")}),e.on("disconnected",function(){console.log("disconnected")}),e.on("reconnecting",function(){console.log("reconnecting")}),e.on("error",function(n,e){console.log("error: "+e)}),e.on("connect_timeout",function(){console.log("connect_timeout")}),e.on("timeout",function(){console.log("timeout")}),e.on("discard_send_buffer",function(n,e){console.log("discard_send_buffer: ");for(var t=0;t<e.length;t++)console.log("  i: "+e[t])}),e.onMessage(function(n){console.log("onMessage: "+n)}),e):void console.log("BitMonster: failed to initialize socket!")}();return e.module=function(){var n=14,e=14,o=c.channel("call"),r=c.channel("event"),i={},a={};o.onMessage(function(n){var e=function(){console.log("BitMonster: received invalid call request from server.")};if(n=JSON.parse(n),!n.callbackID||0===String(n.callbackID).length)return void e();var t=i[n.callbackID];if(!t)return void e();delete i[n.callbackID];try{if("cleanup"===n.type)return;"success"===n.type&&t.success?n.data?t.success(n.data):t.success():"error"===n.type&&t.error?n.message?t.error(n.message):t.error():e()}catch(o){console.log("BitMonster: catched exception while calling callback:"),console.log(o)}}),r.onMessage(function(n){var e=function(){console.log("BitMonster: received invalid event request from server.")};if(n=JSON.parse(n),!n.eventID||0===String(n.eventID).length)return void e();var t=a[n.eventID];if(!t)return void e();try{if("trigger"===n.type){var o;n.data&&(o=JSON.parse(n.data)),t.callback(o)}else e()}catch(r){console.log("BitMonster: catched exception while triggering event:"),console.log(r)}});var s=function(e,r){var c=!1,a=!1,s=!1,u=function(){console.log("BitMonster: invalid method call: module='"+e+"' method='"+r+"'")};if(!r)return u(),!1;for(var l=2;l<arguments.length;l++){var f=arguments[l];if(null!==f&&"object"==typeof f){if(c!==!1)return u(),!1;c=f}else{if(!$.isFunction(f))return u(),!1;if(a===!1)a=f;else{if(s!==!1)return u(),!1;s=f}}}c=c?JSON.stringify(c):"";var d={module:e,method:r};if(a!==!1||s!==!1){for(var g;;)if(g=t.randomString(n),!i[g])break;i[g]={success:a,error:s},d.callbackID=g,d.callbackSuccess=a!==!1,d.callbackError=s!==!1}return d=JSON.stringify(d),o.send(t.marshalValues(d,c)),!0},u=function(n,e,t){delete a[t];var o={type:"off",module:n,event:e,eventID:t};o=JSON.stringify(o),r.send(o)},l=function(n,o,i){for(var c;;)if(c=t.randomString(e),!a[c])break;a[c]={event:o,callback:i};var s={type:"on",module:n,event:o,eventID:c};return s=JSON.stringify(s),r.send(s),{off:function(){u(n,o,c)}}};return function(n){return n?{call:function(){return Array.prototype.unshift.call(arguments,n),s.apply(s,arguments)},on:function(){return Array.prototype.unshift.call(arguments,n),l.apply(l,arguments)}}:(console.log("BitMonster: invalid module call: module='"+n+"'"),!1)}}(),e};